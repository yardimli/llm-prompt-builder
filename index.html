<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>LLM Prompt Builder</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
	      crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
	        crossorigin="anonymous"></script>
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link rel="stylesheet" href="index.css">
</head>
<body class="">
<div class="container-fluid mt-2">
	<header class="d-flex flex-wrap justify-content-center py-3 mb-1 border-bottom">
		<a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
			<span class="fs-4 text-body">LLM Prompt Builder</span>
		</a>
		<ul class="nav nav-pills align-items-center">
			<li class="nav-item me-2">
				<select id="projects-dropdown" class="form-select"></select>
			</li>
			<li class="nav-item me-2">
				<a href="/projects" class="btn btn-outline-secondary">Select Projects</a>
			</li>
			<li class="nav-item me-2">
				<button id="loading-indicator" class="btn btn-outline-secondary" style="display: none;">
					<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...
				</button>
			</li>
			<li class="nav-item me-2">
				<button id="unselect-all" class="btn btn-outline-primary">Unselect All Files</button>
			</li>
			<li class="nav-item">
				<button id="toggle-mode" class="btn btn-outline-primary">
					<i class="fas fa-sun"></i>
				</button>
			</li>
		</ul>
	</header>
	<div class="row">
		<div class="col-lg-5 col-md-6">
			<div id="file-tree"></div>
		</div>
		<div class="col-lg-7 col-md-6">
			<textarea id="selected-content" class="form-control"></textarea>
		</div>
	</div>
</div>
<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="searchModalLabel">Search in Folder</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p>Searching within: <strong id="searchModalFolderPath"></strong></p>
				<div class="mb-3">
					<label for="searchTermInput" class="form-label">Search Term (case-insensitive):</label>
					<input type="text" class="form-control" id="searchTermInput" placeholder="Enter text to search for...">
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" class="btn btn-primary" id="performSearchButton">Search Files</button>
			</div>
		</div>
	</div>
</div>

<script>
	// --- Global State ---
	const PROJECTS_KEY = 'llmHelperProjects';
	const LAST_PROJECT_KEY = 'lastSelectedProject';
	let currentProject = null; // { rootIndex: number, path: string }
	let currentSearchFolderPath = null;
	let searchModal = null;
	
	// --- Utility Functions ---
	function showLoading(message = 'Loading...') {
		$('#loading-indicator').text(message).prepend('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ').show();
	}
	
	function hideLoading() {
		$('#loading-indicator').hide();
	}
	
	function getParentPath(filePath) {
		if (!filePath || !filePath.includes('/')) return null;
		return filePath.substring(0, filePath.lastIndexOf('/'));
	}
	
	function getProjectIdentifier(project) {
		if (!project) return null;
		return `${project.rootIndex}_${project.path}`;
	}
	
	function parseProjectIdentifier(identifier) {
		if (!identifier) return null;
		const parts = identifier.split('_');
		return {rootIndex: parseInt(parts[0], 10), path: parts.slice(1).join('_')};
	}
	
	// --- Project & State Management ---
	function saveCurrentProjectState() {
		if (!currentProject) return;
		const openFolders = [];
		$('#file-tree .folder.open').each(function () {
			openFolders.push($(this).data('path'));
		});
		const selectedFiles = [];
		$('#file-tree input[type="checkbox"]:checked').each(function () {
			selectedFiles.push($(this).data('path'));
		});
		const state = {openFolders, selectedFiles};
		const stateKey = `projectState_${getProjectIdentifier(currentProject)}`;
		localStorage.setItem(stateKey, JSON.stringify(state));
		console.log(`State saved for project ${currentProject.path}`);
	}
	
	async function loadProject(identifier) {
		const project = parseProjectIdentifier(identifier);
		if (!project) {
			$('#file-tree').html('<p class="p-3 text-muted">Please select a project.</p>');
			return;
		}
		showLoading(`Loading project "${project.path}"...`);
		currentProject = project;
		localStorage.setItem(LAST_PROJECT_KEY, identifier);
		$('#projects-dropdown').val(identifier);
		
		const stateKey = `projectState_${getProjectIdentifier(currentProject)}`;
		const savedState = JSON.parse(localStorage.getItem(stateKey)) || {openFolders: [], selectedFiles: []};
		
		try {
			// Load the root of the project
			await loadFolders(currentProject.path, null, savedState);
			// Restore the full state (open subfolders, checked files)
			await restoreState(savedState);
		} catch (error) {
			console.error(`Error loading project ${project.path}:`, error);
			alert(`Error loading project. Check console for details.`);
		} finally {
			hideLoading();
		}
	}
	
	function populateProjectsDropdown() {
		const savedProjects = JSON.parse(localStorage.getItem(PROJECTS_KEY)) || [];
		const dropdown = $('#projects-dropdown');
		dropdown.empty();
		
		if (savedProjects.length === 0) {
			dropdown.append($('<option>', {value: '', text: 'No projects selected'}));
			$('#file-tree').html('<p class="p-3 text-muted">No projects configured. Please go to "Select Projects" to begin.</p>');
			return;
		}
		
		savedProjects.sort((a, b) => a.path.localeCompare(b.path));
		savedProjects.forEach(project => {
			const identifier = getProjectIdentifier(project);
			dropdown.append($('<option>', {
				value: identifier,
				text: project.path
			}));
		});
	}
	
	// --- Core File Tree Logic ---
	async function restoreState(state) {
		console.log("Restoring state:", state);
		const pathsToEnsureOpen = new Set(state.openFolders || []);
		(state.selectedFiles || []).forEach(filePath => {
			let parentPath = getParentPath(filePath);
			while (parentPath && parentPath !== currentProject.path) {
				pathsToEnsureOpen.add(parentPath);
				parentPath = getParentPath(parentPath);
			}
		});
		
		const sortedPaths = [...pathsToEnsureOpen].sort((a, b) => a.split('/').length - b.split('/').length);
		
		for (const path of sortedPaths) {
			const folderElement = $(`#file-tree .folder[data-path="${path}"]`);
			if (folderElement.length && !folderElement.hasClass('open')) {
				folderElement.addClass('open');
				await loadFolders(path, folderElement);
			}
		}
		restoreCheckedStates(state.selectedFiles || []);
		updateSelectedContent();
	}
	
	function restoreCheckedStates(selectedFiles) {
		$('#file-tree input[type="checkbox"]').prop('checked', false);
		selectedFiles.forEach(path => {
			const checkbox = $(`#file-tree input[type="checkbox"][data-path="${path}"]`);
			if (checkbox.length) {
				checkbox.prop('checked', true);
			} else {
				console.warn(`Checkbox not found during restore for path: ${path}`);
			}
		});
	}
	
	function loadFolders(path, element) {
		return new Promise((resolve, reject) => {
			if (!currentProject) return reject("No project selected");
			$.ajax({
				url: '/',
				method: 'POST',
				data: {
					action: 'get_folders',
					path: path,
					rootIndex: currentProject.rootIndex
				},
				dataType: 'json',
				success: function (response) {
					if (element) { // It's a subfolder
						element.next('ul').remove();
					} else { // It's the project root
						$('#file-tree').empty();
					}
					
					if (!response || (!response.folders.length && !response.files.length)) {
						if (element && element.hasClass('open')) element.removeClass('open');
						return resolve();
					}
					
					const ul = $('<ul>').addClass('list-unstyled').hide();
					response.folders.sort((a, b) => a.localeCompare(b));
					response.files.sort((a, b) => a.localeCompare(b));
					
					response.folders.forEach(folder => {
						const fullPath = `${path}/${folder}`;
						const li = $('<li>');
						const controls = $('<span>').addClass('folder-controls');
						const span = $('<span>').addClass('folder').text(folder).attr('data-path', fullPath);
						controls.append($('<i>').addClass('fas fa-search folder-search-icon').attr('title', 'Search in this folder'));
						controls.append($('<i>').addClass('fas fa-eraser folder-clear-icon').attr('title', 'Clear selection in this folder'));
						span.append(controls);
						li.append(span);
						ul.append(li);
					});
					
					response.files.forEach(file => {
						const fullPath = `${path}/${file}`;
						const li = $('<li>');
						li.append($('<div>').addClass('checkbox-wrapper').append(
							$('<input>').attr({type: 'checkbox', 'data-path': fullPath})
						));
						li.append($('<span>').addClass('file').text(file).attr('title', fullPath));
						ul.append(li);
					});
					
					if (element) {
						element.after(ul);
						ul.slideDown(200, resolve);
					} else {
						$('#file-tree').html(ul);
						ul.show();
						resolve();
					}
				},
				error: function (xhr, status, error) {
					console.error(`Error loading folders for path ${path}:`, error);
					if (element) element.removeClass('open');
					reject(error);
				}
			});
		});
	}
	
	async function updateSelectedContent() {
		const checkedBoxes = $('#file-tree input[type="checkbox"]:checked');
		if (checkedBoxes.length === 0) {
			$('#selected-content').val('');
			return;
		}
		showLoading(`Loading ${checkedBoxes.length} file(s)...`);
		const requestPromises = [];
		checkedBoxes.each(function () {
			const path = $(this).data('path');
			const promise = $.ajax({
				url: '/',
				method: 'POST',
				data: {action: 'get_file_content', rootIndex: currentProject.rootIndex, path: path},
				dataType: 'json'
			}).then(response => `${path}:\n\n${response.content}\n\n`)
				.catch(error => `/* --- ERROR loading ${path}: ${error.responseJSON?.error || 'Unknown error'} --- */\n\n`);
			requestPromises.push(promise);
		});
		
		try {
			const results = await Promise.all(requestPromises);
			const contentFooter = "All input is minified. \n" +
				"For output format the output.  \n" +
				"For PHP use psr-12 standards.\n" +
				"For javascript use StandardJS but include semicolumns.\n" +
				"For html use W3C standards.\n" +
				"Skip files that dont need to be changed and are provided for reference.\n" +
				"Comment as needed.\n" +
				"Add comments to new lines and modifed sections.\n";
			$('#selected-content').val(results.join('') + contentFooter);
		} catch (error) {
			console.error("Error updating content:", error);
			$('#selected-content').val("/* --- An unexpected error occurred while loading file contents. --- */");
		} finally {
			hideLoading();
		}
	}
	
	async function ensureFileIsVisible(filePath) {
		const parts = filePath.split('/');
		let currentPath = parts[0];
		for (let i = 1; i < parts.length - 1; i++) {
			currentPath = `${currentPath}/${parts[i]}`;
			const folderElement = $(`#file-tree .folder[data-path="${currentPath}"]`);
			if (folderElement.length && !folderElement.hasClass('open')) {
				folderElement.addClass('open');
				try {
					await loadFolders(currentPath, folderElement);
				} catch (error) {
					console.error(`Failed to open folder ${currentPath} while ensuring visibility`, error);
					return false;
				}
			}
		}
		return true;
	}
	
	// --- Document Ready ---
	$(document).ready(function () {
		searchModal = new bootstrap.Modal(document.getElementById('searchModal'));
		
		// Initial Setup
		populateProjectsDropdown();
		const lastProject = localStorage.getItem(LAST_PROJECT_KEY);
		if (lastProject) {
			loadProject(lastProject);
		} else {
			const firstProject = $('#projects-dropdown').val();
			if (firstProject) {
				loadProject(firstProject);
			}
		}
		
		// --- Event Listeners ---
		$('#projects-dropdown').change(function () {
			loadProject($(this).val());
		});
		
		$('#unselect-all').click(function () {
			$('#file-tree input[type="checkbox"]').prop('checked', false);
			updateSelectedContent();
			saveCurrentProjectState();
		});
		
		$('#toggle-mode').click(function () {
			$('body').toggleClass('dark-mode');
			const isDarkMode = $('body').hasClass('dark-mode');
			$(this).find('i').toggleClass('fa-sun fa-moon');
			localStorage.setItem('darkMode', isDarkMode);
		});
		
		if (localStorage.getItem('darkMode') === 'true') {
			$('body').addClass('dark-mode');
			$('#toggle-mode').find('i').removeClass('fa-sun').addClass('fa-moon');
		}
		
		$(document).on('click', '.folder', function (e) {
			e.stopPropagation();
			const $this = $(this);
			if ($this.hasClass('open')) {
				$this.removeClass('open');
				$this.next('ul').slideUp(200, saveCurrentProjectState);
			} else {
				const ul = $this.next('ul');
				if (ul.length) {
					$this.addClass('open');
					ul.slideDown(200, saveCurrentProjectState);
				} else {
					showLoading('Loading folder...');
					$this.addClass('open');
					loadFolders($this.data('path'), $this)
						.then(() => {
							saveCurrentProjectState();
							hideLoading();
						})
						.catch(err => {
							$this.removeClass('open');
							hideLoading();
						});
				}
			}
		});
		
		$(document).on('change', 'input[type="checkbox"]', function (e) {
			e.stopPropagation();
			updateSelectedContent();
			saveCurrentProjectState();
		});
		
		$(document).on('click', '.folder-search-icon', function (e) {
			e.stopPropagation();
			currentSearchFolderPath = $(this).closest('li').find('.folder').data('path');
			$('#searchModalFolderPath').text(currentSearchFolderPath || 'Root');
			searchModal.show();
		});
		
		$(document).on('click', '.folder-clear-icon', function (e) {
			e.stopPropagation();
			const folderPath = $(this).closest('li').find('.folder').data('path');
			if (!folderPath) return;
			const selector = `#file-tree input[type="checkbox"][data-path^="${folderPath}/"]`;
			let uncheckCount = 0;
			$(selector).each(function () {
				if ($(this).prop('checked')) {
					$(this).prop('checked', false);
					uncheckCount++;
				}
			});
			if (uncheckCount > 0) {
				updateSelectedContent();
				saveCurrentProjectState();
			}
		});
		
		$('#searchTermInput').on('keypress', e => e.which === 13 && $('#performSearchButton').trigger('click'));
		
		$('#performSearchButton').click(async function () {
			const searchTerm = $('#searchTermInput').val().trim();
			searchModal.hide();
			if (!searchTerm || !currentSearchFolderPath) return;
			showLoading('Searching files...');
			try {
				const response = await $.ajax({
					url: '/',
					method: 'POST',
					data: {
						action: 'search_files',
						folderPath: currentSearchFolderPath,
						searchTerm: searchTerm,
						rootIndex: currentProject.rootIndex
					},
					dataType: 'json'
				});
				
				if (response.matchingFiles && response.matchingFiles.length > 0) {
					let successfulChecks = 0;
					for (const filePath of response.matchingFiles) {
						const isVisible = await ensureFileIsVisible(filePath);
						if (isVisible) {
							const checkbox = $(`#file-tree input[type="checkbox"][data-path="${filePath}"]`);
							if (checkbox.length && !checkbox.prop('checked')) {
								checkbox.prop('checked', true);
								successfulChecks++;
							}
						}
					}
					if (successfulChecks > 0) {
						updateSelectedContent();
						saveCurrentProjectState();
						alert(`Selected ${successfulChecks} new file(s) containing "${searchTerm}".`);
					} else {
						alert(`Found files containing "${searchTerm}", but no *new* files were selected.`);
					}
				} else {
					alert(`No files found containing "${searchTerm}" in "${currentSearchFolderPath}".`);
				}
			} catch (error) {
				alert(`Search failed: ${error.responseJSON?.error || 'Unknown error'}`);
			} finally {
				hideLoading();
			}
		});
	});
</script>
</body>
</html>
